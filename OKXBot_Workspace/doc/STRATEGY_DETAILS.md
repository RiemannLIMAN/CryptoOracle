# 📖 核心交易逻辑与资金管理手册 (Strategy & Capital Guide)

本文档详细解析了 CryptoOracle 的资金管理机制与交易决策逻辑，帮助用户理解机器人“怎么分钱”、“怎么买”以及“怎么卖”。

---

## 一、 资金分配与利用 (Capital Allocation & Utilization)

机器人并非简单地读取账户总余额，而是采用了一套类似**企业预算管理**的机制，确保每个币种的资金是隔离且受控的。

### 1. 资金分配 (Allocation)
在 `config.json` 中，您定义了总本金 (`initial_balance_usdt`) 和每个币种的配额 (`allocation`)。

*   **逻辑公式**：
    $$
    \text{该币种分配额度 (Quota)} = \text{总本金} \times \text{分配比例 (allocation)}
    $$
    > **示例**：总本金 1000U，ETH 分配 0.3 (30%)，则 ETH 的专属额度为 300U。

### 2. 资金利用与隔离 (Utilization & Isolation)
在每次交易前，代码 (`execute_trade` 函数) 会执行严格的**“资金舱壁”**检查：

1.  **计算已用资金**：
    机器人首先会检查当前已经持有了多少该币种（现货余额或合约保证金）。
    $$
    \text{已占用资金} = \text{当前持仓数量} \times \text{当前价格}
    $$
    > **示例**：您已经持有了 0.1 个 ETH，当前价格 2000U，则已占用 200U。

2.  **计算剩余额度 (Remaining Quota)**：
    $$
    \text{剩余可用额度} = \text{分配额度 (300U)} - \text{已占用资金 (200U)} = 100U
    $$
    > **核心机制**：这意味着，即使您账户里还有 10000U 的闲置 USDT，机器人也只被允许再买 100U 的 ETH。

3.  **余额硬限 (Balance Hard Limit)**：
    最后，机器人会检查账户实际的 USDT 余额。
    $$
    \text{最终购买力} = \min(\text{剩余可用额度}, \text{账户实际余额})
    $$
    > **双重保险**：这确保了机器人既不会超支（受配额限制），也不会透支（受余额限制）。

4.  **特别说明：买卖逻辑分离 (Separation of Buy & Sell)** [核心修正]
    为了防止“满仓无法卖出”的死锁情况，系统对买卖逻辑进行了物理隔离：
    *   **买入 (Buy)**：严格受限于上述的“剩余可用额度”。如果额度为 0，**禁止一切买入行为**。
    *   **卖出 (Sell)**：**完全不受**剩余额度限制，仅受当前持仓数量限制。
    > **意义**：这意味着即使您的资金配额已全部用完（处于满仓状态），当 AI 发出止盈或止损信号时，机器人依然拥有最高权限执行卖出操作，确保逃生通道永远畅通。

---

## 二、 买入与卖出标准 (Trading Standards)

CryptoOracle 摒弃了传统的“金叉死叉”机械逻辑，而是采用 **DeepSeek 大模型 + 传统技术指标** 的混合决策机制。

### 1. 决策输入 (Decision Inputs)
AI 就像一位坐在屏幕前的交易员，它会同时看到以下三类数据：

*   **🧠 右脑 (感知)**：
    *   **K 线形态**：识别头肩顶、双底、收敛三角等形态。
    *   **价格行为**：分析涨跌幅与成交量配合情况。
*   **📐 左脑 (计算)**：
    *   **RSI (14)**：相对强弱指标（判断超买/超卖）。
    *   **MACD (12,26,9)**：趋势动能（判断金叉/死叉/背离）。
    *   **Bollinger Bands (20,2)**：布林带（判断价格是否突破上下轨）。
    *   **ADX (14)**：趋势强度（判断当前是单边暴涨还是横盘震荡）。
*   **💼 账户状态**：
    *   当前持仓的浮动盈亏（新增：让 AI 能感知每一分钱的盈亏）。
    *   剩余可用“子弹”数量。

### 2. 动态买卖标准 (Dynamic Logic)
AI 不会死板地执行命令，而是根据 **ADX 波动率** 动态调整买卖标准（即“动态人格”）。

此外，我们引入了**“止盈保护” (Profit Taking Protection)** 机制：
> **核心规则**：如果持仓盈亏 > 1.5% 且上涨动能减弱（K 线长上影/MACD 红柱缩短），强制卖出锁定利润，拒绝过山车。

**⚠️ v2.1 更新：单边趋势的智慧 (Trend-Aware)**
针对单边行情（如暴涨暴跌），我们升级了 AI 的决策哲学：
1.  **RSI 钝化警示**：在 ADX > 30 的强趋势中，明确告知 AI “RSI 超买是强势特征，而非卖出信号”，防止摸顶空单。
2.  **反手逻辑 (Reversal Logic)**：若持仓方向与趋势严重背离（如持空看涨），AI 将触发“反手机制”，建议平空并反手开多，而非死扛。
3.  **止损优先**：当浮亏 > 3% 且趋势未变时，**不要等待 K 线形态确认**，直接止损离场。

| 市场状态 | AI 人格 | 🟢 买入标准 (Buy Criteria) | 🔴 卖出标准 (Sell Criteria) |
| :--- | :--- | :--- | :--- |
| **单边暴涨**<br>(High Trend) | 🦁 **激进派** | 只要趋势未破（ADX强），允许追高买入/反手开多。 | 只有趋势明确反转才卖；**严禁仅凭 RSI 超买做空**。 |
| **剧烈震荡**<br>(Choppy) | 🦉 **避险派** | 极度苛刻，只有在布林带下轨且 RSI 超卖时才博反弹。 | 稍有盈利立即止盈，或者遇到阻力位即卖。 |
| **横盘**<br>(Low Volatility) | 🐼 **网格派** | 区间下沿买入。 | 区间上沿卖出。 |

### 3. 执行前的“四重门” (Quadruple Check Execution)
即使 AI 喊出了“买入”，交易也不会立即执行，必须通过严苛的四重校验：

### 1. ⏱️ 价格时效性检查 (Freshness Check)
代码会对比 `分析时的价格` 和 `当前最新价格`。如果偏差 > **1%**（说明分析过程中市场发生了剧烈波动或插针），**立即取消交易**，防止追涨杀跌在山顶。

### 2. 📉 智能最小交易适配 (Smart Micro-Trade Adaption) [核心优化]
针对小资金用户，机器人不再简单地因“金额不足”而拒单，而是尝试**自动适配**：

*   **数量自适应**：
    *   **问题**：AI 建议买 80 个 DOGE，但交易所最小限制是 100 个。
    *   **解决**：若余额允许，系统自动将下单量**提升至 100 个**，确保成交。
*   **金额自适应**：
    *   **问题**：计算出的交易额为 1.5 USDT，但交易所最小要求 2 USDT。
    *   **解决**：系统自动计算补足到 2.1 USDT (含 5% 缓冲) 所需的币数，并尝试下单。

> **注意**：这仅适用于 **BUY (买入)** 信号。对于卖出，若持仓不足最小限制，通常只能留作尘埃 (Dust) 无法交易。

### 3. 🛡️ 净利润风控拦截 (Net-Profit Guard) [新增]
为了防止 AI 频繁进行微利交易（"赚了指数赔了本金"），系统引入了基于**真实费率**的拦截机制：

*   **自动费率检测**：启动时自动识别您的 VIP 等级（Taker 费率）。
*   **保本线计算**：
    $$
    \text{保本线} = (\text{Taker费率} \times 2) + 0.05\% \text{ (滑点缓冲)}
    $$
    *   *现货 (Lv1)*: 约 0.25%
    *   *合约 (Lv1)*: 约 0.15%
*   **拦截逻辑**：如果 AI 建议卖出，但浮盈 < 保本线，且不是为了止损（浮盈>0），系统将**强制拦截**，修改决策为 `HOLD`。
    > *日志提示：`🛑 拦截微利平仓: 当前浮盈 0.15% < 0.25% (手续费覆盖线)`*

### 4. 💰 资金风控取小 (The "Min" Logic)

最终下单数量的计算逻辑如下，分为**普通模式**和**激进模式**：

#### A. 普通模式 (Normal Mode)
默认情况下，为了稳健运行，系统取三者的最小值：
1.  `config_amount`：配置文件设定的单笔数量（如 0.05 SOL）。
2.  `ai_suggest_amount`：AI 建议的仓位（通常与配置一致）。
3.  `max_afford`：账户实际购买力（含配额限制）。

$$
\text{最终下单量} = \min(\text{用户配置}, \text{AI建议}, \text{资金上限})
$$

#### B. 🦁 激进模式 (Aggressive Mode) [新增]
当 AI 对当前行情极度看好（识别出完美底部形态），并在信号中标记 `confidence: HIGH` 时，系统将**临时解除单笔配置限制**：

1.  **解除对象**：忽略 `config_amount` 限制。
2.  **保留底线**：依然受 `max_afford` (资金配额) 的绝对限制，防止爆仓连累其他币种。
3.  **执行逻辑**：
    $$
    \text{最终下单量} = \min(\text{AI建议}, \text{资金上限})
    $$
    > **示例**：配置每次买 10U，但配额剩 50U。若 AI 信心爆棚建议买 50U，系统会果断执行 50U 买入（梭哈配额），而不是死板地买 10U。

### 5. 🏗️ 仓位构建与加仓 (Position Building & Pyramiding) [新增]

系统不仅仅支持“一键梭哈”，更支持专业的**金字塔式加仓 (Pyramiding)** 策略。这解释了“建仓”的真正含义：分批入场，降低风险，顺势加码。

*   **加仓机制**：
    *   **触发条件**：
        1.  当前已经持有底仓（例如持有 0.1 BTC 多单）。
        2.  AI 再次发出强烈的 `BUY` 信号（确认趋势延续）。
        3.  **资金配额未满**：当前持仓占用资金 < 该币种总分配额度 (`allocation`)。
    *   **执行动作**：
        *   机器人会在现有持仓基础上，继续买入一笔 (`amount`)。
        *   持仓均价会根据新买入价格进行加权平均。
    *   **意义**：
        *   **容错**：初始只建立小仓位试探市场，方向对了再加码，错了止损损失小。
        *   **利润最大化**：在单边大行情中，通过不断加仓（滚雪球），大幅放大收益。

> **示例**：您给 ETH 分配了 1000U 额度，每次买入 100U。
> 1. 价格 2000，AI 买入 100U (底仓)。
> 2. 价格涨到 2100，趋势确认，AI 再次买入 100U (加仓)。
> 3. ... 直到持仓达到 1000U 上限，或趋势反转。

---

## 三、 自动计算与配置 (Auto Configuration)

为了降低配置门槛，机器人引入了多项自动化机制，让您只需关注资金分配，无需纠结具体数值。

### 1. 智能下单数量 (`amount: "auto"`)
当您在 `config.json` 中将 `amount` 设置为 `"auto"` 时，机器人会执行以下逻辑：

1.  **基准计算**：默认取该币种总分配额度 (`allocation`) 的 **10%** 作为单笔交易基准。
    > *设计哲学：这预留了 10 次加仓的机会，非常适合金字塔式建仓。*
2.  **最小限额修正**：查询交易所该交易对的 `Min Order Size` (最小下单量) 和 `Min Order Cost` (最小下单金额)。
    *   如果计算出的 10% 份额小于交易所限制，系统会**自动提升**到最小限制的 1.5 倍，确保订单能发出去。
3.  **动态换算**：每次交易前，根据当前实时币价，将 USDT 金额换算为精确的币数。

### 2. 费率自动同步 (Smart Fee Sync)
机器人不再依赖硬编码的费率。每次启动及运行期间（每 4 小时），它会主动向交易所查询您的账户费率等级 (VIP Level)。
*   **作用**：获取精准的 Taker/Maker 费率（例如 0.05% vs 0.02%）。
*   **意义**：这直接决定了“净利润风控拦截”的阈值，确保机器人不会因为误判费率而进行亏本交易。

---

## 四、 风控层级与冲突说明 (Risk Hierarchy)

很多用户会问：**“新加入的 AI 止盈策略，会和我在配置文件里设置的 `max_profit_rate` 冲突吗？”**

答案是：**完全不会。它们分属不同的战略层级，互为补充。**

### 1. ⚔️ 战术层：AI 灵活止盈 (Tactical Take-Profit)
*   **执行者**：DeepSeek AI (单兵作战)
*   **触发条件**：单币种浮盈 > 1.5% 且动能减弱。
*   **动作**：卖出当前币种，锁定小额利润。
*   **后果**：机器人**继续运行**，寻找下一个买入机会（积少成多）。
*   **目的**：优化波段收益，防止利润回撤。

### 2. 🏰 战略层：全局刚性止盈 (Strategic Stop-Profit)
*   **执行者**：RiskManager (全局指挥官)
*   **触发条件**：账户**总权益**达到配置文件设定的目标（如 `max_profit_rate: 0.2` 即赚 20%）。
*   **动作**：清空**所有**持仓，强制停止机器人程序 (System Exit)。
*   **后果**：机器人**停止运行**，发送庆祝战报。
*   **目的**：落袋为安，完成阶段性投资目标。

> **总结**：AI 负责帮您**“赚小钱、不停赚”**，配置风控负责帮您**“守大钱、不归零”**。二者双剑合璧，并不冲突。

---

## 五、 总结 (Summary)

*   **怎么分钱**：按比例切分蛋糕，专款专用，互不挪用。
*   **怎么买**：AI 看图 + 指标确认 + 价格没飞 + 资金够用 = **买入**。
*   **怎么卖**：AI 觉得趋势坏了 + 或者是达到了止盈位 + 或者是触发了风控 = **卖出**。
